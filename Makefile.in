include Makefile.common

DIST=@PACKAGE@-@VERSION@
DISTDIR=@top_srcdir@/$(DIST)
ARCHIVE=$(DIST).tar
TARBALL=$(ARCHIVE).gz

SUBDIRS=src/modules src
DOC=AUTHORS LICENSE README.md TODO doc
DISTFILES=configure Makefile.common.in Makefile.in config.h.in config $(SUBDIRS) $(DOC)
CONFIGFILES=mopherd.conf.example mail.acl.example

.PHONY: $(SUBDIRS)

all: $(SUBDIRS)

install: all
	for SUBDIR in $(SUBDIRS); do\
		( cd $$SUBDIR && $(MAKE) install )\
	done

	$(INSTALL_DIR) $(DESTDIR)$(CONFIG_PATH)
	for CF in $(CONFIGFILES); do\
		$(INSTALL_DATA) @top_srcdir@/config/$$CF $(DESTDIR)$(CONFIG_PATH);\
	done

uninstall:
	for SUBDIR in $(SUBDIRS); do\
		( cd $$SUBDIR && $(MAKE) uninstall )\
	done
	rm -ri $(DESTDIR)$(CONFIG_PATH)

$(SUBDIRS):
	@cd $@ && $(MAKE)

clean:
	for SUBDIR in $(SUBDIRS); do\
		( cd $$SUBDIR && $(MAKE) clean )\
	done

distclean: clean
	rm -f $(ACFILES)
	rm -f $(TARBALL)

dist: clean $(TARBALL)

$(DISTDIR):
	mkdir $(DISTDIR)
	cp -dpr $(DISTFILES) $(DISTDIR)

$(TARBALL): $(ARCHIVE)
	rm -f $@
	$(GZIP) $<

$(ARCHIVE): $(DISTDIR)
	$(TAR) cf $@ $(DISTDIR)
	rm -rf $(DISTDIR)
