# Makefile

include Makefile.common

DOC=			AUTHORS LICENSE README.md TODO doc
CONFIGFILES=		mopherd.conf.example mail.acl.example

DIST=			@PACKAGE@-@VERSION@
DISTDIR=		$(DIST)
DISTFILES=		$(DOC) src config configure Makefile.common.in \
			Makefile.in config.h.in
ARCHIVE=		$(DIST).tar
TARBALL=		$(ARCHIVE).gz

SUBDIR=			src/modules src

.PHONY: $(SUBDIR)

all: $(SUBDIR)

$(SUBDIR):
	@cd $@ && $(MAKE)

install: install_program install_modules install_config

install_program:
	$(INSTALL_DIR) $(DESTDIR)$(PROGRAM_PATH)
	for P in $(PROG); do \
		$(INSTALL_PROG) src/$$P $(DESTDIR)$(PROGRAM_PATH); \
	done

install_modules:
	$(INSTALL_DIR) $(DESTDIR)$(MODULE_PATH)
	$(INSTALL_PROG) src/modules/*.so $(DESTDIR)$(MODULE_PATH)

install_config:
	$(INSTALL_DIR) $(DESTDIR)$(CONFIG_PATH)
	for CF in $(CONFIGFILES); do\
		$(INSTALL_DATA) config/$$CF $(DESTDIR)$(CONFIG_PATH);\
	done

uninstall:
	-for P in $(PROG); do \
		rm -i $(DESTDIR)$(PROGRAM_PATH)/$$P; \
	done
	-rm -ri $(DESTDIR)$(MODULE_PATH)
	-rm -ri $(DESTDIR)$(CONFIG_PATH)

clean:
	for DIR in $(SUBDIR); do \
		( cd $$DIR; make $@ );\
	done

distclean: clean
	-rm -rf $(ACFILES) $(DISTDIR) $(ARCHIVE) $(TARBALL)

dist: distclean $(TARBALL)

configure:
	$(SHELL) bootstrap.sh

$(DISTDIR): configure
	mkdir $(DISTDIR)
	cp -PRp $(DISTFILES) $(DISTDIR)

$(ARCHIVE): $(DISTDIR)
	$(TAR) cf $@ $(DISTDIR)

$(TARBALL): $(ARCHIVE)
	$(GZIP) $<
