# Makefile

include Makefile.common

DOC=			AUTHORS LICENSE README.md TODO doc
CONF=			mopherd.conf.example mail.acl.example

DIST=			@PACKAGE@-@VERSION@
DISTDIR=		$(DIST)
DISTFILES=		$(DOC) src config configure Makefile.common.in \
			Makefile.in config.h.in
ACFILES=		config.h Makefile Makefile.common src/Makefile \
			src/modules/Makefile
ARCHIVE=		$(DIST).tar
TARBALL=		$(ARCHIVE).gz

SUBDIR=			src/modules src
MAKE_SUBDIR=            for i in $(SUBDIR); do $(MAKE) -C $$i $$target; done


all: subdir

subdir:
	$(MAKE_SUBDIR)

install: install_program install_modules install_config

install_program:
	$(INSTALL_DIR) $(DESTDIR)$(PROGRAM_PATH)
	for P in $(PROG); do \
		$(INSTALL_PROG) src/$$P $(DESTDIR)$(PROGRAM_PATH); \
	done

install_modules:
	$(INSTALL_DIR) $(DESTDIR)$(MODULE_PATH)
	$(INSTALL_PROG) src/modules/*.so $(DESTDIR)$(MODULE_PATH)

install_config:
	$(INSTALL_DIR) $(DESTDIR)$(CONF_PATH)
	for C in $(CONF); do\
		$(INSTALL_DATA) config/$$C $(DESTDIR)$(CONF_PATH);\
	done

uninstall:
	-for P in $(PROG); do \
		rm -i $(DESTDIR)$(PROGRAM_PATH)/$$P; \
	done
	-rm -ri $(DESTDIR)$(MODULE_PATH)
	-rm -ri $(DESTDIR)$(CONF_PATH)

clean:
	$$target=$@; $(MAKE_SUBDIR)

distclean: clean
	-rm -rf $(ACFILES) $(DISTDIR) $(ARCHIVE) $(TARBALL)

dist: distclean $(TARBALL)

configure:
	aclocal
	autoconf

$(DISTDIR): configure
	mkdir $(DISTDIR)
	cp -PRp $(DISTFILES) $(DISTDIR)

$(ARCHIVE): $(DISTDIR)
	$(TAR) cf $@ $(DISTDIR)

$(TARBALL): $(ARCHIVE)
	$(GZIP) $<
