include Makefile.common

DIST=@PACKAGE@-@VERSION@
DISTDIR=@top_srcdir@/$(DIST)
ARCHIVE=$(DIST).tar
TARBALL=$(ARCHIVE).gz

build=@top_srcdir@/build
modules=@top_srcdir@/build/modules

SUBDIRS=src
DOC=AUTHORS LICENSE README.md TODO doc
DISTFILES=configure Makefile.common.in Makefile.in config.h.in config $(SUBDIRS) $(DOC)
PROGRAMS=mopherd moco


.PHONY: clean
.PHONY: distclean
.PHONY: install
.PHONY: uninstall
.PHONY: $(SUBDIRS)
.PHONY: $(ARCHIVE)


all: $(SUBDIRS)

install: all
	$(INSTALL_DIR) $(DESTDIR)$(sbindir)
	$(INSTALL_DIR) $(DESTDIR)$(sysconfdir)/mopher
	$(INSTALL_DIR) $(DESTDIR)$(MOPHERD_DIR)/modules
	for PROGRAM in $(PROGRAMS); do \
		$(INSTALL_PROGRAM) $(build)/$$PROGRAM $(DESTDIR)$(sbindir)/$$PROGRAM; \
	done
	$(INSTALL_PROGRAM) $(modules)/*.so $(DESTDIR)$(MOPHERD_DIR)/modules
	$(INSTALL_DATA) @top_srcdir@/config/*.example $(DESTDIR)$(sysconfdir)/mopher

uninstall:
	rm -rf $(sysconfdir)/mopher
	rm -rf $(MOPHERD_DIR)
	rm -f $(sbindir)/mopherd
	rm -f $(sbindir)/moco

$(SUBDIRS):
	@cd $@ && $(MAKE)

clean:
	rm -rf $(build)

distclean: clean
	rm -f $(ACFILES)
	rm -f $(TARBALL)

dist: clean $(TARBALL)

$(DISTDIR):
	mkdir $(DISTDIR)
	cp -dpr $(DISTFILES) $(DISTDIR)

$(TARBALL): $(ARCHIVE)
	rm -f $@
	$(GZIP) $<

$(ARCHIVE): $(DISTDIR)
	$(TAR) cf $@ $(DISTDIR)
	rm -rf $(DISTDIR)
