include @top_srcdir@/Makefile.common

DIST=@PACKAGE@-@VERSION@
DISTDIR=@top_srcdir@/$(DIST)
ARCHIVE=$(DIST).tar
TARBALL=$(ARCHIVE).gz

SUBDIRS=src man
DOC=AUTHORS  BUGS  CODE LICENSE README.md TODO doc
DISTFILES=configure Makefile.common.in Makefile.in config.h.in config $(SUBDIRS) $(DOC)


.PHONY: clean
.PHONY: distclean
.PHONY: install
.PHONY: uninstall
.PHONY: $(SUBDIRS)
.PHONY: $(ARCHIVE)


all: $(SUBDIRS)

install: all
	@echo 
	@echo creating directories
	$(INSTALL) -m 755 -o 0 -g 0 -d $(sysconfdir)/mopher
	$(INSTALL) -m 755 -o 0 -g 0 -d $(MOPHERD_DIR)
	$(INSTALL) -m 755 -o 0 -g 0 -d $(MOPHERD_DIR)/db
	$(INSTALL) -m 755 -o 0 -g 0 -d $(MOPHERD_DIR)/modules
	@echo 
	@echo installing mopherd in $(sbindir)
	$(INSTALL) -m 755 -o 0 -g 0 @top_srcdir@/src/mopherd $(sbindir)
	@echo 
	@echo installing modules in $(MOPHERD_DIR)
	-$(INSTALL) -m 755 -o 0 -g 0 @top_srcdir@/src/modules/*.so $(MOPHERD_DIR)/modules
	@echo 
	@echo installing configuration files in $(sysconfdir)
	$(INSTALL) -m 640 -o 0 -g 0 @top_srcdir@/config/mopherd.conf $(sysconfdir)/mopher
	$(INSTALL) -m 640 -o 0 -g 0 @top_srcdir@/config/mail.acl $(sysconfdir)/mopher
	@echo
	@echo installing man pages in $(mandir)
	$(INSTALL) -m 755 -o 0 -g 0 -d $(man1dir)
	$(INSTALL) -m 755 -o 0 -g 0 -d $(man5dir)
	$(INSTALL) -m 644 -o 0 -g 0 @top_srcdir@/man/*.1.gz $(man1dir)
	$(INSTALL) -m 644 -o 0 -g 0 @top_srcdir@/man/*.5.gz $(man5dir)

uninstall:
	@echo removing $(DIST) files
	@rm -rf $(sysconfdir)/mopher
	@rm -rf $(MOPHERD_DIR)
	@rm -f $(sbindir)/mopherd

$(SUBDIRS):
	@cd $@ && $(MAKE)

clean:
	@for d in $(SUBDIRS); do (cd $$d && $(MAKE) clean); done

distclean: clean
	@-rm -f $(ACFILES)
	@-rm -f $(TARBALL)

dist: clean $(TARBALL)

$(DISTDIR):
	mkdir $(DISTDIR)
	cp -dpr $(DISTFILES) $(DISTDIR)

$(TARBALL): $(ARCHIVE)
	-rm -f $@
	$(GZIP) $<

$(ARCHIVE): $(DISTDIR)
	$(TAR) cf $@ $(DISTDIR)
	rm -rf $(DISTDIR)
