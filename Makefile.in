# Makefile

include Makefile.common

SUBDIR=			src/modules src
MAKE_SUBDIR=		for i in $(SUBDIR); do $(MAKE) -C $$i $$target; done

all: subdir

subdir:
	$(MAKE_SUBDIR)

install: install_program install_modules install_config

install_program:
	$(INSTALL_DIR) $(DESTDIR)$(PROGRAM_PATH)
	for P in $(PROG); do \
		$(INSTALL_PROG) src/$$P $(DESTDIR)$(PROGRAM_PATH); \
	done

install_modules:
	$(INSTALL_DIR) $(DESTDIR)$(MODULE_PATH)
	$(INSTALL_PROG) src/modules/*.so $(DESTDIR)$(MODULE_PATH)

install_config:
	$(INSTALL_DIR) $(DESTDIR)$(CONFIG_INST)
	for C in $(CONF); do \
		$(INSTALL_DATA) config/$$C \
			$(DESTDIR)$(CONFIG_INST); \
	done

uninstall:
	-for P in $(PROG); do \
		rm -i $(DESTDIR)$(PROGRAM_PATH)/$$P; \
	done
	-rm -ri $(DESTDIR)$(MODULE_PATH)
	-rm -ri $(DESTDIR)$(CONFIG_INST)

regdom_rules.dat:
	p=http://hg.mozilla.org/mozilla-central/raw-file/tip/netwerk/dns; \
	wget -O- $$p/effective_tld_names.dat >$@
regdom_rules.py:
	p=http://hg.mozilla.org/mozilla-central/raw-file/tip/netwerk/dns; \
	wget -O- $$p/prepare_tlds.py >$@
regdom_rules: regdom_rules.py regdom_rules.dat
	python2 $> $^ >$@

regdom.c: regdom_rules

clean:
	target=$@; $(MAKE_SUBDIR)
