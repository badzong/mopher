# Makefile, src

include @top_srcdir@/Makefile.common

PROG+=			test_run # built, not installed

GENSRC=			cf_yacc.c acl_yacc.c cf_lex.c acl_lex.c
SRC=			$(GENSRC) defs.c cf.c acl.c milter.c module.c \
			ll.c ht.c sht.c var.c vp.c vlist.c vtable.c \
			log.c hash.c util.c dbt.c greylist.c sock.c \
			client.c server.c exp.c parser.c tarpit.c \
			msgmod.c pipe.c regdom.c test.c
OBJ=			$(SRC:.c=.o) cf_defaults.o

CFLAGS+=		-I@top_srcdir@ -I@top_srcdir@/src/include
CFLAGS.defs.o=		-DMODULE_PATH=\"$(MODULE_PATH)\" \
			-DMOPHERD_CONF=\"$(MOPHERD_CONF)\" \
			-DMOPHERD_ACL=\"$(MOPHERD_ACL)\" \
			-DREGDOM_RULES=\"$(REGDOM_RULES)\"

YFLAGS.cf_yacc.c=	-pcf_
YFLAGS.acl_yacc.c=	-pacl_
XFLAGS.cf_lex.c=	-Pcf_
XFLAGS.acl_lex.c=	-Pacl_

.PHONY: all

all: $(PROG)

$(PROG): $(OBJ)
	$(CC) $(CFLAGS) -o $@ $@.c $(OBJ) $(LDFLAGS)

clean:
	-rm $(PROG) $(GENSRC:.c=.[ch]) $(OBJ)

.SUFFIXES: .conf .l .y .c .o
.y.o:	# unset
.l.o:	# unset
.y.c:
	$(YACC) $(YFLAGS) $(YFLAGS.$@) -o $@ $<
.l.c:
	$(LEX) -t $(XFLAGS.$@) $< > $@
.c.o:
	$(CC) $(CFLAGS) $(CFLAGS.$@) -c $< -o $@
.conf.o:
	$(LD) -r -b binary -o $@ $> $^
	$(OBJCOPY) --rename-section \
		.data=.rodata,alloc,load,readonly,data,contents $@ $@
