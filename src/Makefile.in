include @top_srcdir@/Makefile.common

INCLUDE=-I@top_srcdir@ -I@top_srcdir@/src/include -I$(build)
CFLAGS+=$(INCLUDE)

build=@top_srcdir@/build
modules=@top_srcdir@/build/modules

PROGRAMS=\
	$(build)/mopherd\
	$(build)/moco

OBJECTS=\
	$(build)/defs.o\
	$(build)/cf_yacc.o\
	$(build)/cf_lex.o\
	$(build)/cf.o\
	$(build)/cf_defaults.o\
	$(build)/acl_yacc.o\
	$(build)/acl_lex.o\
	$(build)/acl.o\
	$(build)/milter.o\
	$(build)/module.o\
	$(build)/ll.o\
	$(build)/ht.o\
	$(build)/sht.o\
	$(build)/var.o\
	$(build)/vlist.o\
	$(build)/vtable.o\
	$(build)/log.o\
	$(build)/hash.o\
	$(build)/util.o\
	$(build)/dbt.o\
	$(build)/greylist.o\
	$(build)/sock.o\
	$(build)/client.o\
	$(build)/server.o\
	$(build)/exp.o\
	$(build)/parser.o\
	$(build)/tarpit.o\
	$(build)/msgmod.o

GENSRC=\
	$(build)/cf_yacc.c\
	$(build)/cf_yacc.h\
	$(build)/cf_lex.c\
	$(build)/acl_yacc.c\
	$(build)/acl_yacc.h\
	$(build)/acl_lex.c\

SUBDIRS=modules

.PHONY: $(SUBDIRS)

all: $(build) $(SUBDIRS) $(PROGRAMS)

$(build):
	mkdir -p $(build)

$(SUBDIRS):
	cd $@ && $(MAKE)

$(build)/defs.o: defs.c
	$(CC) $(CFLAGS) -DMOPHERD_DIR=\"$(MOPHERD_DIR)\" -DMOPHERD_CONF=\"$(MOPHERD_CONF)\" -DMAIL_ACL=\"$(MAIL_ACL)\" -c $< -o $@

$(build)/cf_defaults.o: cf_defaults.conf
	ld -r -b binary -o $@ $<
	$(OBJCOPY) --rename-section .data=.rodata,alloc,load,readonly,data,contents $@ $@

$(build)/cf_yacc.c: cf_yacc.y
	$(YACC) $(YFLAGS) -p cf_ $< -o $@

$(build)/cf_lex.c: cf_lex.l
	$(LEX) -t -Pcf_ $< > $@

$(build)/acl_yacc.c: acl_yacc.y
	$(YACC) $(YFLAGS) -p acl_ $< -o $@

$(build)/acl_lex.c: acl_lex.l
	$(LEX) -t -Pacl_ $< > $@

$(build)/mopherd: Makefile $(OBJECTS) $(LIBS) mopherd.c
	$(CC) $(CFLAGS) -o $@ $(OBJECTS) mopherd.c $(LDFLAGS)

$(build)/moco: Makefile $(OBJECTS) $(LIBS) moco.c
	$(CC) $(CFLAGS) -o $@ $(OBJECTS) moco.c $(LDFLAGS)

$(build)/%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@
